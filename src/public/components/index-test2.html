<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>西安城乡融合要素交易市场数据可视化展示平台</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        /* 主页面样式 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #4fc3f7 0%, #0288d1 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #4fc3f7 0%, #0288d1 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        .status-bar {
            background: #f8f9fa;
            padding: 15px 30px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4fc3f7 0%, #0288d1 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
        }
        .user-details {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .user-name {
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }
        .user-role {
            font-size: 12px;
            color: #666;
        }
        .logout-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.2s ease;
        }
        .logout-btn:hover {
            background: #c82333;
        }
        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        .status-connected { background: #28a745; }
        .status-disconnected { background: #dc3545; }
        .status-connecting { background: #ffc107; }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .data-info { display: flex; gap: 20px; flex-wrap: wrap; }
        .info-item { display: flex; align-items: center; gap: 8px; color: #6c757d; }
        .info-item i { color: #0095ff; }
        .table-container { padding: 30px; overflow-x: auto; }
        .table-wrapper { background: white; border-radius: 15px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08); overflow: hidden; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th {
            background: linear-gradient(135deg, #4fc3f7 0%, #0288d1 100%);
            color: white;
            padding: 18px 15px;
            text-align: left;
            font-weight: 600;
            font-size: 15px;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        th:first-child { border-top-left-radius: 15px; }
        th:last-child { border-top-right-radius: 15px; }
        td { padding: 15px; border-bottom: 1px solid #f1f3f4; transition: background-color 0.2s ease; }
        tr:hover td { background-color: #f8f9ff; }
        tr:last-child td { border-bottom: none; }
        .amount-cell { font-weight: 600; color: #28a745; text-align: left; }
        .count-cell { font-weight: 600; color: #007bff; text-align: center; }
        .category-cell { font-weight: 500; color: #495057; }
        .region-cell { font-weight: 500; color: #6c757d; text-align: center; }
        .table-wrapper td:nth-child(2) { text-align: left; }
        .loading { text-align: center; padding: 60px 20px; color: #6c757d; }
        .loading i { font-size: 3em; color: #0095ff; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .no-data { text-align: center; padding: 60px 20px; color: #6c757d; }
        .no-data i { font-size: 4em; color: #dee2e6; margin-bottom: 20px; }
        .refresh-btn {
            background: linear-gradient(135deg, #4fc3f7 0%, #0288d1 100%); 
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: transform 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .refresh-btn:hover { transform: translateY(-2px); }
        .refresh-btn:active { transform: translateY(0); }
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 30px 30px 30px;
        }
        .stat-card { background: #e3f2fd; padding: 25px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08); text-align: center; transition: transform 0.2s ease; }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-card i { font-size: 2.5em; margin-bottom: 15px; }
        .stat-card .stat-value { font-size: 2em; font-weight: bold; margin-bottom: 5px; }
        .stat-card .stat-label { color: #6c757d; font-size: 0.9em; }
        .card-total { color: #0288d1; }
        .card-categories { color: #039be5; }
        .card-amount { color: #00bcd4; }
        .card-count { color: #4fc3f7; }
        .echarts-card { background: #e3f2fd; border-radius: 18px; box-shadow: 0 8px 24px rgba(2,136,209,0.10), 0 1.5px 4px rgba(2,136,209,0.08); margin: 30px 30px 0 30px; padding: 24px 24px 12px 24px; max-width: none; min-width: 0; border: 1.5px solid #b3e5fc; }
        #echarts-map { width: 100%; min-height: 480px; height: 52vw; max-height: 600px; margin: 0 auto; border-radius: 12px; box-shadow: 0 2px 8px rgba(2,136,209,0.08); background: #e3f2fd; }
        @media (max-width: 768px) {
            .container { max-width: 100%; border-radius: 0; }
            .header { padding: 18px; font-size: 1.2em; }
            .status-bar { flex-direction: column; align-items: flex-start; }
            .stats-cards { grid-template-columns: 1fr; }
            .table-container { padding: 15px; }
            th, td { padding: 12px 8px; font-size: 13px; }
        }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .echarts-card { background: #e3f2fd; border-radius: 18px; box-shadow: 0 8px 24px rgba(2,136,209,0.10), 0 1.5px 4px rgba(2,136,209,0.08); margin: 30px 30px 0 30px; padding: 24px 24px 12px 24px; max-width: none; min-width: 0; border: 1.5px solid #b3e5fc; }
        #echarts-map { width: 100%; min-height: 480px; height: 52vw; max-height: 600px; margin: 0 auto; border-radius: 12px; box-shadow: 0 2px 8px rgba(2,136,209,0.08); background: #e3f2fd; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-chart-line"></i> 西安城乡融合要素交易市场</h1>
            <p>数据可视化展示平台</p>
        </div>
        <div class="status-bar" style="display:flex;justify-content:space-between;align-items:center;gap:0;flex-wrap:wrap;">
            <div class="data-info" style="display:flex;align-items:center;gap:32px;">
                <div class="connection-status" style="display:flex;align-items:center;gap:8px;">
                    <div class="status-indicator status-connecting" id="status-indicator"></div>
                    <span id="connection-text">正在连接...</span>
                </div>
                <div class="info-item" style="display:flex;align-items:center;gap:6px;">
                    <i class="fas fa-clock"></i>
                    <span id="last-update">--</span>
                </div>
                <div class="info-item" style="display:flex;align-items:center;gap:6px;">
                    <i class="fas fa-database"></i>
                    <span id="record-count">0 条记录</span>
                </div>
            </div>
            <div class="user-info" id="user-info" style="display: none;">
                <div class="user-avatar" id="user-avatar">U</div>
                <div class="user-details">
                    <div class="user-name" id="user-name">用户</div>
                    <div class="user-role" id="user-role">角色</div>
                </div>
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    退出
                </button>
            </div>
            <div class="btn-group" style="display:flex;align-items:center;gap:16px;">
                <button class="refresh-btn" onclick="refreshConnection()">
                    <i class="fas fa-sync-alt"></i>
                    重连数据库
                </button>
                <button class="refresh-btn" style="background:linear-gradient(135deg,#81d4fa 0%,#0288d1 100%);" onclick="exportExcel()">
                    <i class="fas fa-file-excel"></i>
                    导出Excel
                </button>
            </div>
        </div>
        <div id="echarts-bar" style="width:100%;height:320px;margin:30px 0 18px 0;padding-left:30px;"></div>

        <!-- ECharts地图卡片 -->
        <div class="stats-cards" id="stats-cards" style="display: none;">
            <div class="stat-card">
                <i class="fas fa-list card-total"></i>
                <div class="stat-value" id="total-records">0</div>
                <div class="stat-label">总记录数</div>
            </div>
            <div class="stat-card">
                <i class="fas fa-tags card-categories"></i>
                <div class="stat-value" id="total-categories">0</div>
                <div class="stat-label">项目类别</div>
            </div>
            <div class="stat-card">
                <i class="fas fa-yen-sign card-amount"></i>
                <div class="stat-value" id="total-amount">0</div>
                <div class="stat-label">总成交金额(元)</div>
            </div>
            <div class="stat-card">
                <i class="fas fa-handshake card-count"></i>
                <div class="stat-value" id="total-count">0</div>
                <div class="stat-label">总成交笔数</div>
            </div>
        </div>
        <div class="echarts-card" style="position: relative;">
            <div id="region-filter-box" style="position:absolute;left:24px;top:24px;z-index:1200;background:rgba(255,255,255,0.95);border-radius:8px;padding:8px 16px;box-shadow:0 2px 8px rgba(2,136,209,0.08);display:flex;align-items:center;gap:8px;">
                <i class="fas fa-filter" style="color:#4fc3f7;"></i>
                <label for="region-filter" style="color:#666;font-weight:500;">行政区筛选：</label>
                <select id="region-filter" onchange="onRegionFilterChange()" style="font-size:15px;padding:2px 8px;border-radius:4px;border:1px solid #b3e5fc;outline:none;">
                    <option value="ALL">全部</option>
                </select>
            </div>
            <div id="echarts-map"></div>
            <div id="highlight-counter" style="display:none;position:absolute;right:32px;bottom:80px;z-index:1100;background:rgba(255,255,255,0.9);border-radius:8px;padding:8px 16px;font-size:14px;font-weight:bold;box-shadow:0 2px 6px rgba(0,0,0,0.06);color:#e67e22;">
                - 存在交易的街道数量为：<span id="highlight-count">0</span>
            </div>
            <div id="legend-note" style="display:none;position:absolute;right:32px;bottom:32px;z-index:1100;background:rgba(255,255,255,0.9);border-radius:8px;padding:8px 16px;font-size:14px;color:#666;box-shadow:0 2px 6px rgba(0,0,0,0.06);">
                - 灰色部分为未涉及交易的区域
            </div>
        </div>

        <div class="table-container">
            <div class="table-wrapper">
<table id="data-table">
    <thead>
        <tr>
                            <th><i class="fas fa-map-marker-alt"></i> 行政区划</th>
                            <th><i class="fas fa-road"></i> 街道名称</th>
                            <th><i class="fas fa-tag"></i> 项目类别</th>
                            <th><i class="fas fa-yen-sign"></i> 成交金额(元)</th>
                            <th><i class="fas fa-handshake"></i> 成交笔数</th>
        </tr>
    </thead>
    <tbody id="table-body">
                        <tr>
                            <td colspan="4" class="loading">
                                <i class="fas fa-spinner"></i>
                                <div>正在加载数据...</div>
                            </td>
                        </tr>
    </tbody>
</table>
            </div>
        </div>
    </div>

<script>
        let socket = null;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;
        let allData = [];
        let currentRegion = 'ALL';
        let latestData = [];
        let firstRenderDone = false;

        //行政区划码与区县名称映射
        const regionMap = {
            '610102': '新城区',
            '610103': '碑林区',
            '610104': '莲湖区',
            '610111': '灞桥区',
            '610112': '未央区',
            '610113': '雁塔区',
            '610114': '阎良区',
            '610115': '临潼区',
            '610116': '长安区',
            '610117': '高陵区',
            '610118': '鄠邑区',
            '610122': '蓝田县',
            '610124': '周至县',
            '610193': '西咸新区',
            '610191': '高新区',
            '610192': '国际港务区'
        };

document.addEventListener('DOMContentLoaded', function() {
            connectWebSocket();
        });

        function connectWebSocket() {
            updateConnectionStatus('connecting', '正在连接数据库...');
            
            socket = new WebSocket('ws://localhost:3000');

    socket.onopen = () => {
        console.log('Connected to WebSocket server');
                updateConnectionStatus('connected', '数据库已连接');
                reconnectAttempts = 0;
    };

    socket.onmessage = (event) => {
    try {
        const payload = JSON.parse(event.data);
        const data = payload.data || payload;
        latestData = data;
        //收到推送更新数据和更新时间
        renderData(latestData);
        if (payload.dbConnectTime) {
            updateLastUpdate(new Date(payload.dbConnectTime));
        }
        firstRenderDone = true;
    } catch (error) {
        console.error('Error parsing data:', error);
    }
};

    socket.onerror = (error) => {
        console.error('WebSocket error:', error);
                updateConnectionStatus('disconnected', '数据库连接错误');
    };

    socket.onclose = () => {
        console.log('Disconnected from WebSocket server');
                updateConnectionStatus('disconnected', '数据库连接断开');
                
                if (reconnectAttempts < maxReconnectAttempts) {
                    reconnectAttempts++;
                    setTimeout(() => {
                        console.log(`Attempting to reconnect... (${reconnectAttempts}/${maxReconnectAttempts})`);
                        connectWebSocket();
                    }, 3000);
                }
            };
        }

        function updateConnectionStatus(status, text) {
            const indicator = document.getElementById('status-indicator');
            const textElement = document.getElementById('connection-text');
            
            indicator.className = `status-indicator status-${status}`;
            textElement.textContent = text;
        }

        function updateLastUpdate(time) {
            const now = time || new Date();
            const month = now.getMonth() + 1;
            const day = now.getDate();
            const timeString = now.toLocaleTimeString('zh-CN');
            document.getElementById('last-update').textContent = `更新时间: ${month}月${day}日 ${timeString}`;
        }

        function renderData(data) {
            allData = data;
            updateRegionFilterOptions(data);
            filterAndRender();
            renderBarChart(data);
        }

        function updateRegionFilterOptions(data) {
            const select = document.getElementById('region-filter');
            const regions = Array.from(new Set(data.map(row => (row['区代码'] || '').substring(0, 6)))).filter(r => r);
            regions.sort();
            select.innerHTML = '<option value="ALL">全部</option>' +
                regions.map(region => {
                    const name = regionMap[region] || region;
                    return `<option value="${region}">${name}</option>`;
                }).join('');
            select.value = currentRegion;
        }

        function onRegionFilterChange() {
            const select = document.getElementById('region-filter');
            currentRegion = select.value;
            filterAndRender();
            //联动ECharts
            if (window.myChart && typeof showDistrictStreets === 'function' && typeof returnToDistrictView === 'function') {
                if (currentRegion === 'ALL') {
                    if (window.currentView !== 'districts') {
                        returnToDistrictView();
                    }
                } else {
                    const regionMapReverse = Object.entries(regionMap).reduce((acc, [code, name]) => { acc[code] = name; return acc; }, {});
                    const districtName = regionMap[currentRegion] || currentRegion;
                    if (window.currentView !== 'streets' || window.selectedDistrict !== districtName) {
                        showDistrictStreets(districtName);
                    }
                }
            }
        }

        function filterAndRender() {
            let filtered = allData;
            if (currentRegion !== 'ALL') {
                filtered = allData.filter(row => (row['区代码'] || '').substring(0, 6) === currentRegion);
            }
            if (!filtered || filtered.length === 0) {
                showNoData();
                return;
            }
            document.getElementById('stats-cards').style.display = 'grid';
            updateStats(filtered);
            renderTable(filtered);
            mergeCells(document.getElementById('data-table'), 0);
            mergeCells(document.getElementById('data-table'), 1); 
        }

        function updateStats(data) {
            const totalRecords = data.length;
            const totalCategories = new Set(data.map(row => row['项目类别'])).size;
            const totalAmount = data.reduce((sum, row) => sum + (parseFloat(row['成交金额']) || 0), 0);
            const totalCount = data.reduce((sum, row) => sum + (parseInt(row['成交笔数']) || 0), 0);

            document.getElementById('total-records').textContent = totalRecords;
            document.getElementById('total-categories').textContent = totalCategories;
            document.getElementById('total-amount').textContent = totalAmount.toFixed(2);
            document.getElementById('total-count').textContent = totalCount;
            document.getElementById('record-count').textContent = `${totalRecords} 条记录`;
        }

function renderTable(data) {
    const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';

            data.forEach((row, index) => {
        const tr = document.createElement('tr');
                tr.className = 'fade-in';
                tr.style.animationDelay = `${index * 0.05}s`;

                //行政区划
                const td1 = document.createElement('td');
                td1.className = 'region-cell';
                const regionCode = (row['区代码'] || '').substring(0, 6);
                td1.textContent = regionMap[regionCode] || regionCode || '--';
                tr.appendChild(td1);

                // 街道名称
                const tdStreet = document.createElement('td');
                tdStreet.className = 'region-cell';
                tdStreet.textContent = row['街道'] || '--';
                tr.appendChild(tdStreet);

                //项目类别
                const td2 = document.createElement('td');
                td2.className = 'category-cell';
                td2.textContent = row['项目类别'] || '--';
                tr.appendChild(td2);

                //成交金额
                const td3 = document.createElement('td');
                td3.className = 'amount-cell';
                const amount = parseFloat(row['成交金额']) || 0;
                td3.textContent = amount.toLocaleString('zh-CN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                tr.appendChild(td3);

                //成交笔数
                const td4 = document.createElement('td');
                td4.className = 'count-cell';
                td4.textContent = row['成交笔数'] || '0';
                tr.appendChild(td4);

        tbody.appendChild(tr);
    });
}

        function showNoData() {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = `
                <tr>
                    <td colspan="4" class="no-data">
                        <i class="fas fa-inbox"></i>
                        <div>暂无数据</div>
                    </td>
                </tr>
            `;
            document.getElementById('stats-cards').style.display = 'none';
}

function mergeCells(table, columnIndex) {
    let lastRowContent = null;
    let rowspanCount = 0;

    for (let i = 1; i < table.rows.length; i++) {
        const currentCell = table.rows[i].cells[columnIndex];
        if (lastRowContent === currentCell.textContent) {
            rowspanCount++;
            currentCell.style.display = 'none';
        } else {
            if (rowspanCount > 0) {
                table.rows[i - rowspanCount - 1].cells[columnIndex].setAttribute('rowspan', rowspanCount + 1);
            }
            lastRowContent = currentCell.textContent;
            rowspanCount = 0;
        }
    }

    if (rowspanCount > 0) {
        table.rows[table.rows.length - rowspanCount - 1].cells[columnIndex].setAttribute('rowspan', rowspanCount + 1);
    }
}

        function refreshConnection() {
            if (socket) {
                socket.close();
            }
            firstRenderDone = false;
            reconnectAttempts = 0;
            connectWebSocket();
        }

        //ECharts地图集成
        function getDistrictColor(name) {
            const colorMap = {
                '新城区': '#4ECDC4',
                '碑林区': '#45B7D1',
                '莲湖区': '#96CEB4',
                '灞桥区': '#FF6B6B',
                '未央区': '#DDA0DD',
                '雁塔区': '#98D8C8',
                '阎良区': '#F7DC6F',
                '临潼区': '#BB8FCE',
                '长安区': '#85C1E9',
                '高陵区': '#F8C471',
                '鄠邑区': '#82E0AA',
                '蓝田县': '#F1948A',
                '周至县': '#D7BDE2',
                '高新区': '#A9CCE3',
                '国际港务区': '#F9E79F',
                '经开区': '#D5A6BD',
                '曲江新区': '#A2D9CE',
                '浐灞生态区': '#FAD7A0',
                '其它': '#BFC9CA'
            };
            return colorMap[name] || '#BFC9CA';
        }
        var myChart = echarts.init(document.getElementById('echarts-map'));
        let allStreetData = [];
        let currentView = 'districts';
        let selectedDistrict = null;
        let districtOption = null;

        function bindDistrictClick() {
            myChart.off('click');
            myChart.on('click', function(params) {
                const districtName = params.name;
                if (districtName && currentView === 'districts') {
                    showDistrictStreets(districtName);//下钻
                    //下拉框和表格
                    const select = document.getElementById('region-filter');
                    if (select) {
                        //反查区划码
                        let code = Object.keys(regionMap).find(key => regionMap[key] === districtName);
                        if (code) {
                            select.value = code;
                            currentRegion = code;
                            filterAndRender();
                        }
                    }
                }
            });
        }

        //ECharts内置返回按钮（用graphic实现）
        function setBackButton(show) {
            myChart.setOption({
                graphic: show ? [{
                    type: 'group',
                    left: 1,
                    top: 70,
                    z: 1000,
                    children: [
                        {
                            type: 'rect',
                            shape: { width: 80, height: 29, r: 8 },
                            style: {
                                fill: 'rgba(255,255,255,0.9)',
                                shadowBlur: 6,
                                shadowColor: 'rgba(0,0,0,0.06)',
                                cursor: 'pointer',
                                stroke: 'transparent',
                                lineWidth: 0
                            },
                            onclick: function() { returnToDistrictView(); }
                        },
                        {
                            type: 'text',
                            left: 14,
                            top: 8,
                            style: {
                                text: '\u25C0',
                                font: 'bold 14px "Segoe UI", "微软雅黑", Arial',
                                fill: '#e67e22',
                                cursor: 'pointer',
                            },
                            onclick: function() { returnToDistrictView(); }
                        },
                        {
                            type: 'text',
                            left: 30,
                            top: 8,
                            style: {
                                text: '返回',
                                font: 'bold 14px "Segoe UI", "微软雅黑", Arial',
                                fill: '#666',
                                cursor: 'pointer',
                            },
                            onclick: function() { returnToDistrictView(); }
                        }
                    ]
                }] : []
            });
        }
        fetch('/assets/Data/陕西街道.geojson')
            .then(response => response.json())
            .then(geoJson => {
                const xianDistricts = geoJson.features.filter(feature =>
                    feature.properties && feature.properties.市 === '西安市' && feature.properties.区
                );
                allStreetData = geoJson.features.filter(feature =>
                    feature.properties && feature.properties.市 === '西安市'
                );
                const xianGeoJson = {
                    type: 'FeatureCollection',
                    features: xianDistricts
                };
                xianGeoJson.features.forEach(feature => {
                    if (feature.properties && feature.properties.区) {
                        feature.properties.name = feature.properties.区;
                    }
                });
                echarts.registerMap('xian_district', xianGeoJson);
                const mapData = xianDistricts.map(feature => {
                    const districtName = feature.properties.区 || feature.properties.name || '其它';
                    return {
                        name: districtName,
                        value: 1,
                        itemStyle: {
                            areaColor: getDistrictColor(districtName)
                        }
                    };
                });
                districtOption = {
                    backgroundColor: '#f7f9fa',
                    title: {
                        text: '西安市区地图',
                        left: 'center',
                        top: 32,
                        textStyle: {
                            fontSize: 22,
                            fontWeight: 'bold',
                            color: '#222',
                            fontFamily: '"Segoe UI", "微软雅黑", Arial, sans-serif'
                        }
                    },
                    tooltip: {
                        trigger: 'item',
                        backgroundColor: '#222',
                        borderRadius: 6,
                        textStyle: { color: '#fff', fontSize: 15 },
                        formatter: function(params) {
                            return params.name || '';
                        }
                    },
                    series: [
                        {
                            type: 'map',
                            map: 'xian_district',
                            roam: false,
                            label: { show: false },
                            itemStyle: { borderColor: '#fff', borderWidth: 1 },
                            emphasis: {
                                label: { show: false },
                                itemStyle: { areaColor: '#b3e5fc', borderColor: '#0288d1', borderWidth: 2 }
                            },
                            data: mapData
                        }
                    ]
                };
                myChart.setOption(districtOption);
                setBackButton(false);
                bindDistrictClick();
            });
        function showDistrictStreets(districtName) {
            const streetsInDistrict = allStreetData.filter(feature => 
                feature.properties && feature.properties.区 === districtName
            );
            if (streetsInDistrict.length > 0) {
                selectedDistrict = districtName;
                currentView = 'streets';
                const streetGeoJson = {
                    type: 'FeatureCollection',
                    features: streetsInDistrict
                };
                streetGeoJson.features.forEach(feature => {
                    if (feature.properties && feature.properties.Name) {
                        feature.properties.name = feature.properties.Name;
                    }
                });
                echarts.registerMap('street_detail', streetGeoJson);

                //获取当前表格数据中有交易的街道名
                let filterRegion = currentRegion;
                //若通过点击地图进入，currentRegion可能还没切换，需用districtName反查区划码
                if (!filterRegion || filterRegion === 'ALL') {
                    //反查区划码
                    filterRegion = Object.keys(regionMap).find(key => regionMap[key] === districtName) || '';
                }
                const tradedStreets = new Set(
                    allData
                        .filter(row => (row['区代码'] || '').substring(0, 6) === filterRegion)
                        .map(row => row['街道'])
                        .filter(Boolean)
                );
                //高亮计数器
                document.getElementById('highlight-counter').style.display = 'block';
                document.getElementById('highlight-count').textContent = tradedStreets.size;
                //图例说明
                document.getElementById('legend-note').style.display = 'block';

                //生成街道数据，区分高亮与灰色
                const streetData = streetsInDistrict.map(feature => {
                    const name = feature.properties.Name || '未知街道';
                    const hasTrade = tradedStreets.has(name);
                    return {
                        name,
                        value: 1,
                        itemStyle: {
                            areaColor: hasTrade ? '#f5b97f' : '#e0e0e0',
                            borderColor: '#fff',
                            borderWidth: 1
                        }
                    };
                });

                var streetOption = {
                    backgroundColor: '#f7f9fa',
                    title: {
                        text: `${districtName} - 街道详情`,
                        left: 'center',
                        top: 32,
                        textStyle: {
                            fontSize: 20,
                            fontWeight: 'bold',
                            color: '#222',
                            fontFamily: '"Segoe UI", "微软雅黑", Arial, sans-serif'
                        }
                    },
                    tooltip: {
                        trigger: 'item',
                        backgroundColor: '#222',
                        borderRadius: 6,
                        textStyle: { color: '#fff', fontSize: 14 },
                        formatter: function(params) {
                            return params.name || '';
                        }
                    },
                    series: [
                        {
                            type: 'map',
                            map: 'street_detail',
                            roam: false,
                            label: {
                                show: true,
                                fontSize: 12,
                                color: '#333',
                                fontWeight: 'bold',
                                backgroundColor: 'rgba(255,255,255,0.85)',
                                borderRadius: 4,
                                padding: [2, 6]
                            },
                            itemStyle: { borderColor: '#fff', borderWidth: 1 },
                            emphasis: {
                                label: {
                                    show: true,
                                    fontSize: 13,
                                    color: '#fff',
                                    fontWeight: 'bold',
                                    backgroundColor: '#0288d1',
                                    borderRadius: 5,
                                    padding: [2, 8]
                                },
                                itemStyle: { areaColor: '#b3e5fc', borderColor: '#0288d1', borderWidth: 2 }
                            },
                            data: streetData
                        }
                    ]
                };
                myChart.setOption(streetOption, true);
                setTimeout(() => {
                    myChart.dispatchAction({
                        type: 'restore'
                    });
                    setBackButton(true);
                }, 10);
                myChart.off('click'); 
            }
        }
        function returnToDistrictView() {
            currentView = 'districts';
            selectedDistrict = null;
            //强制重建主视图option，彻底刷新ECharts状态
            const mapData = (allStreetData.filter(feature => feature.properties && feature.properties.区)
                .map(feature => {
                    const districtName = feature.properties.区 || feature.properties.name || '其它';
                    return {
                        name: districtName,
                        value: 1,
                        itemStyle: {
                            areaColor: getDistrictColor(districtName)
                        }
                    };
                }));
            const resetOption = {
                backgroundColor: '#f7f9fa',
                title: {
                    text: '西安市区地图',
                    left: 'center',
                    top: 32,
                    textStyle: {
                        fontSize: 22,
                        fontWeight: 'bold',
                        color: '#222',
                        fontFamily: '"Segoe UI", "微软雅黑", Arial, sans-serif'
                    }
                },
                tooltip: {
                    trigger: 'item',
                    backgroundColor: '#222',
                    borderRadius: 6,
                    textStyle: { color: '#fff', fontSize: 15 },
                    formatter: function(params) {
                        return params.name || '';
                    }
                },
                series: [
                    {
                        type: 'map',
                        map: 'xian_district',
                        roam: false,
                        label: { show: false },
                        itemStyle: { borderColor: '#fff', borderWidth: 1 },
                        emphasis: {
                            label: { show: false },
                            itemStyle: { areaColor: '#b3e5fc', borderColor: '#0288d1', borderWidth: 2 }
                        },
                        data: mapData
                    }
                ]
            };
            myChart.setOption(resetOption, true); 
            setBackButton(false);
            bindDistrictClick(); 
            //联动下拉框和表格
            const select = document.getElementById('region-filter');
            if (select) {
                select.value = 'ALL';
                currentRegion = 'ALL';
                filterAndRender();
    }
    //隐藏高亮计数器
    document.getElementById('highlight-counter').style.display = 'none';
    //隐藏图例说明
    document.getElementById('legend-note').style.display = 'none';
}

        //区县成交金额Top5 柱状图
        function renderBarChart(data) {
            if (!window.echarts) return;
            const barDom = document.getElementById('echarts-bar');
            if (!barDom) return;
            const myBar = echarts.init(barDom);
            //统计各区县成交金额
            const regionMap = {
                '610102': '新城区', '610103': '碑林区', '610104': '莲湖区', '610111': '灞桥区',
                '610112': '未央区', '610113': '雁塔区', '610114': '阎良区', '610115': '临潼区',
                '610116': '长安区', '610117': '高陵区', '610118': '鄠邑区', '610122': '蓝田县',
                '610124': '周至县', '610193': '西咸新区', '610191': '高新区', '610192': '国际港务区'
            };
            //区县分组
            const regionData = {};
            data.forEach(row => {
                const code = (row['区代码'] || '').substring(0,6);
                const name = regionMap[code] || code;
                if (!regionData[name]) regionData[name] = 0;
                regionData[name] += parseFloat(row['成交金额']) || 0;
            });
            //排序取Top5
            const sorted = Object.entries(regionData).sort((a,b)=>b[1]-a[1]).slice(0,5);
            const names = sorted.map(x=>x[0]);
            const values = sorted.map(x=>x[1]);
            const option = {
                title: {
                    text: '区县成交金额TOP5',
                    left: 'left',
                    top: 10,
                    textStyle: { color: '#0288d1', fontSize: 18, fontWeight: 600 }
                },
                grid: { left: 40, right: 20, top: 60, bottom: 30 },
                tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
                xAxis: {
                    type: 'category',
                    data: names,
                    axisLine: { lineStyle: { color: '#0288d1' } },
                    axisLabel: { color: '#0288d1', fontWeight: 500 }
                },
                yAxis: {
                    type: 'value',
                    axisLine: { lineStyle: { color: '#0288d1' } },
                    splitLine: { lineStyle: { color: '#b3e5fc' } },
                    axisLabel: { color: '#0288d1' }
                },
                series: [{
                    data: values,
                    type: 'bar',
                    barWidth: 32,
                    itemStyle: {
                        color: new echarts.graphic.LinearGradient(0,0,0,1,[
                            {offset:0,color:'#4fc3f7'},{offset:1,color:'#0288d1'}
                        ]),
                        borderRadius: [8,8,0,0]
                    },
                    label: {
                        show: true, position: 'top', color: '#0288d1', fontWeight: 600,
                        formatter: v => v.value.toLocaleString('zh-CN', {minimumFractionDigits:2,maximumFractionDigits:2})
                    }
                }]
            };
            myBar.setOption(option);
            window.addEventListener('resize', ()=>{myBar.resize();});
        }

        //导出为Excel
        function exportExcel() {
            const table = document.getElementById('data-table');
            if (!table) return;
            const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.innerText.replace(/\s+/g, ''));
            const rows = Array.from(table.querySelectorAll('tbody tr'));
            if (!rows.length || rows[0].classList.contains('loading') || rows[0].classList.contains('no-data')) {
                alert('暂无可导出的数据！');
                return;
            }
            const data = rows.map(tr => Array.from(tr.querySelectorAll('td')).map(td => td.innerText));
            //SheetJS数据
            const ws_data = [headers, ...data];
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, '筛选结果');
            //文件名含日期
            const now = new Date();
            const pad = n => n.toString().padStart(2, '0');
            const fname = `筛选结果_${now.getFullYear()}${pad(now.getMonth()+1)}${pad(now.getDate())}_${pad(now.getHours())}${pad(now.getMinutes())}${pad(now.getSeconds())}.xlsx`;
            XLSX.writeFile(wb, fname);
        }

        // 用户信息处理
        function initUserInfo() {
            const userInfo = localStorage.getItem('sso_user_info');
            if (userInfo) {
                try {
                    const user = JSON.parse(userInfo);
                    displayUserInfo(user);
                } catch (error) {
                    console.error('解析用户信息失败:', error);
                }
            } else {
                // 如果没有用户信息，检查是否是从SSO页面跳转过来的
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('code')) {
                    // 如果有code参数，说明是从统一登录跳转过来的，需要验证
                    window.location.href = '/sso/index.html' + window.location.search;
                }
            }
        }

        // 显示用户信息
        function displayUserInfo(user) {
            const userInfoElement = document.getElementById('user-info');
            const userAvatarElement = document.getElementById('user-avatar');
            const userNameElement = document.getElementById('user-name');
            const userRoleElement = document.getElementById('user-role');

            if (userInfoElement && userAvatarElement && userNameElement && userRoleElement) {
                // 显示用户信息区域
                userInfoElement.style.display = 'flex';
                
                // 设置用户头像（使用用户名首字母）
                const displayName = user.nickname || user.username || '用户';
                userAvatarElement.textContent = displayName.charAt(0).toUpperCase();
                
                // 设置用户名
                userNameElement.textContent = displayName;
                
                // 设置用户角色
                const roleText = user.roleid ? `角色ID: ${user.roleid}` : '普通用户';
                userRoleElement.textContent = roleText;
            }
        }

        // 退出登录
        function logout() {
            if (confirm('确定要退出系统吗？')) {
                // 清除本地存储的用户信息
                localStorage.removeItem('sso_user_info');
                localStorage.removeItem('sso_login_time');
                
                // 直接跳转到统一登录系统
                const exiturl = localStorage.getItem('sso_exiturl');
                if (exiturl) {
                    window.location.href = exiturl;
                } else {
                    // 如果没有退出地址，跳转到模拟统一登录页面
                    window.location.href = '/test-sso.html';
                }
            }
        }

        // 页面加载完成后初始化用户信息
        document.addEventListener('DOMContentLoaded', function() {
            initUserInfo();
        });
</script>
</body>
</html>


